<?php/*6/27/2011 10:04:51 AM Andy- Make all branch default sort by sequence, code.2/17/2012 11:41:06 AM Alex- change use report server5/14/2012 5:20:43 PM Justin- Modified to include the status of "used" by POS.- Added new sub query to capture and validate voucher used date and branch.- Fixed the bugs that do not show the correct result while user filter with status "Cancelled".5/30/2012 10:52:23 AM Justin- Added new filter option "Used Branch" to show only those vouchers from related branch from POS.- Fixed bugs of system show 2 days records even user just select 1 day.6/5/2012 10:20:54 AM Justin- Bug Fixed for having extra "and" under sql query.*/include("include/common.php");include("include/class.report.php");if (!$login) js_redirect($LANG['YOU_HAVE_LOGGED_OUT'], "/index.php");include("masterfile_voucher.include.php");class REPORT_VOUCHER_ACTIVATION extends Module{     function __construct($title){        global $con, $smarty, $sessioninfo;		//default assign        if (!$_REQUEST['to_date']) $_REQUEST['to_date'] = date('Y-m-d');		if (!$_REQUEST['from_date']) $_REQUEST['from_date'] = date('Y-m-d', strtotime("-1 month"));		//Branches		$con->sql_query("select * from branch where active=1 order by sequence,code");		while($r = $con->sql_fetchrow()){			$branches[$r['id']] = $r;		}		$smarty->assign("branches", $branches);        $bid  = get_request_branch();        $this->bid=$bid;       	$smarty->assign('form',$_REQUEST);    	parent::__construct($title);    }	function _default(){		$this->display();		exit;	}	function show_report(){		$this->generate_report();		$this->display();	}	function output_excel(){	    global $smarty, $sessioninfo;				$this->generate_report();        include_once("include/excelwriter.php");    	$smarty->assign('no_header_footer', true);    	$filename = "voucher_activation_".time().".xls";    	log_br($sessioninfo['id'], 'REPORT_EXPORT', 0, "Export Voucher Activation Report To Excel($filename)");    	Header('Content-Type: application/msexcel');		Header('Content-Disposition: attachment;filename='.$filename);		print ExcelWriter::GetHeader();		$this->display();		print ExcelWriter::GetFooter();	    exit;	}		function generate_report(){	    global $con, $smarty, $sessioninfo;		$form=$_REQUEST;        $con_multi=new mysql_multi();        //$con_multi = $con;		$filter = $q1_filter = array();		//================start filter===================		//branch		if ($form['branch_id'] != 'all'){		    $report_title[]="Issued Branch: ".get_branch_code($this->bid);			$filter[] = "mv.branch_id = ".mi($this->bid);		}else{            $report_title[]="Issued Branch: All";		}		if ($form['used_branch_id'] != 'all'){		    $report_title[]="Used Branch: ".get_branch_code($form['used_branch_id']);			$q1_filter[] = "pos.branch_id = ".mi($form['used_branch_id']);			$filter_used_branch = true;		}else{            $report_title[]="Used Branch: All";		}		//date	    $report_title[]="Date: ".$form['from_date']." to ".$form['to_date'];		$from_date=ms($form['from_date']);		$from_timestamp=ms($form['from_date']." 00:00:00");		$to_timestamp=ms($form['to_date']." 23:59:59");		//$to_timestamp=ms(date("Y-m-d",strtotime('+1 days'.$form['to_date'])));        if ($form['status'] == 'All'){		    $report_title[]="Status: All";            $filter[]= "(mv.activated between $from_timestamp and $to_timestamp or mv.cancelled between $from_timestamp and $to_timestamp)";		}elseif ($form['status'] == '1'){		    $report_title[]="Status: Actived";            $filter[]= "mv.cancel_status=0";			$filter[]= "mv.activated between $from_timestamp and $to_timestamp";		}elseif ($form['status'] == '2'){			$report_title[]="Status: Cancelled";            $filter[]= "mv.cancel_status=1 and mv.cancelled between $from_timestamp and $to_timestamp";		}else{			$q1_filter[] = "pos.date between $from_timestamp and $to_timestamp";			$report_title[]="Status: Used";		}		//search code		if ($form['search_code']){		    $code_length = strlen($form['search_code']);		    if ($code_length == 7 )		    	$filter[]="mv.code=".ms($form['search_code']);            elseif ($code_length < 7 )                $filter[]="mv.code = ".ms(str_pad($form['search_code'],7,"0",STR_PAD_LEFT));			else		        $err[]="Invalid Code";	        $report_title[] = "Code: $form[search_code]";		}		if ($form['active_remark'] != ''){			$report_title[] = "Active Remark: ".$form['active_remark'];			$filter[]="mv.active_remark = ".ms($form['active_remark']);		}        				$smarty->assign('report_title', join("&nbsp;&nbsp;&nbsp;&nbsp;",$report_title));		if ($filter)    $where = "where ".join(" and ", $filter);		if ($q1_filter)    $q1_filters = " and ".join(" and ", $q1_filter);		//==============end filter====================		$sql="select mv.*,LPAD(mv.code,7,0) as code,branch.code as branch_code, u1.u as activator, u2.u as creator, u3.u as cancellator			from mst_voucher mv			left join branch on mv.branch_id=branch.id 			left join user u1 on mv.active_user_id=u1.id			left join user u2 on mv.create_user_id=u2.id			left join user u3 on mv.cancel_user_id=u3.id			$where			order by code";		$con_multi->sql_query($sql);		if ($con_multi->sql_numrows()>0){			while($r=$con_multi->sql_fetchrow()){				// check whether this voucher has being used or not				$q1 = $con->sql_query("select pos.pos_time as used_time, b.code as used_branch_code									   from pos_payment pp									   left join pos on pp.counter_id=pos.counter_id and pp.branch_id=pos.branch_id and pp.pos_id=pos.id and pp.date=pos.date									   left join branch b on b.id = pos.branch_id									   where pos.cancel_status=0 and pp.type='VOUCHER' and length(pp.remark)=12 and pp.remark like ".ms($r['code'].'%').$q1_filters);								if($con->sql_numrows($q1)>0){					$used_info = $con->sql_fetchassoc($q1);					$detail[$r['code']]['used_time']=$used_info['used_time'];					$detail[$r['code']]['used_branch_code']=$used_info['used_branch_code'];					$con->sql_freeresult($q1);				}elseif($form['status'] == "3" || $filter_used_branch) continue;				$detail[$r['code']]['branch_code']=$r['branch_code'];				$detail[$r['code']]['voucher_value']=$r['voucher_value'];				$detail[$r['code']]['code']=$r['code'];				$detail[$r['code']]['activated']=$r['activated'];				$detail[$r['code']]['active_remark']=$r['active_remark'];				$detail[$r['code']]['activator']=$r['activator'];				$detail[$r['code']]['valid_date_from']=$r['valid_from'];				$detail[$r['code']]['valid_date_to']=$r['valid_to'];				$detail[$r['code']]['cancelled']=$r['cancelled'];				$detail[$r['code']]['cancel_remark']=$r['cancel_remark'];				$detail[$r['code']]['cancellator']=$r['cancellator'];				$detail[$r['code']]['added']=$r['added'];				$detail[$r['code']]['creator']=$r['creator'];							}		}		$smarty->assign('table', 1);		$smarty->assign('detail', $detail);	}}$report = new REPORT_VOUCHER_ACTIVATION('Voucher Activation & Cancellation Report');?>