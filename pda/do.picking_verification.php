<?php/**/include("common.php");include("class.scan_product.php");if (!$login) js_redirect($LANG['YOU_HAVE_LOGGED_OUT'], "/pda/index.php");if (!privilege('DO')) js_redirect(sprintf($LANG['NO_PRIVILEGE'], 'DO', BRANCH_CODE), "/pda");$maintenance->check(196);class DO_Picking_Verification extends Scan_Product{    function __construct($title){        global $sessioninfo;	    if(isset($_REQUEST['branch_id'])){			if($_REQUEST['branch_id'] != $sessioninfo['branch_id']){    // prevent edit other branch				header("Location: $_SERVER[PHP_SELF]");				exit;			}		}		parent::__construct($title);	}		function show_scan_product(){	}		function add_items(){	}		function init_module(){	    global $con, $smarty;		if($_SESSION['do']['do_type'])	$smarty->assign('do_type',$_SESSION['do']['do_type']);		elseif($_REQUEST['do_type'])    $smarty->assign('do_type',$_REQUEST['do_type']);		else    $smarty->assign('do_type','transfer');		$do_type = $smarty->get_template_vars('do_type');				$smarty->assign('module_name','DO Picking Verification');				$smarty->assign('PAGE_TITLE','DO Picking Verification');		$smarty->assign('top_include','do.top_include.tpl');		//$smarty->assign('btm_include','do.btm_include.tpl');	}		function default_(){		global $con, $smarty;				$id = mi($_REQUEST['id']);		$branch_id = mi($_REQUEST['branch_id']);				if($id&&$branch_id){			$this->reset_session_do($id,$branch_id);		}else{            $id = mi($_SESSION['do']['id']);            $branch_id = mi($_SESSION['do']['branch_id']);		}				$this->scan_item();	}		function new_do(){		unset($_SESSION['do']);		if($_REQUEST['do_type'])	$_SESSION['do']['do_type'] = $_REQUEST['do_type'];		header("Location: do.picking_verification.php");	}		private function default_load(){		global $con,$smarty;				// nothing to load	}		function open(){		global $con, $smarty, $sessioninfo;				unset($_SESSION['do_picking_verification']['search_var']);		if($_REQUEST['do_no']){			$branch_id = mi($sessioninfo['branch_id']);			$id = mi($_REQUEST['do_no']);			$con->sql_query("select report_prefix from branch where id=$branch_id") or die(mysql_error());			$report_prefix = $con->sql_fetchfield(0);			$sql = "select do.*,branch.code as do_branch_code, branch.description as do_branch_description,debtor.code as debtor_code from do			left join branch on branch.id=do.do_branch_id			left join debtor on debtor.id=do.debtor_id			where do.branch_id=$branch_id and (do.id=$id or do.do_no = ".ms($_REQUEST['do_no']).") and do.active=1";			$q1 = $con->sql_query($sql) or die(mysql_error());			if($con->sql_numrows($q1)<=0){ // no result				$err[] = "No DO Found with $id.";			}elseif($con->sql_numrows($q1)==1){ // straight go to scan barcode if match with only one result				$do_info = $con->sql_fetchassoc($q1);				$con->sql_freeresult($q1);				$_REQUEST['id'] = $do_info['id'];				$_REQUEST['branch_id'] = $do_info['branch_id'];				$this->scan_item();				return;			}else{				$_SESSION['do_picking_verification']['search_var'] = $_REQUEST['do_no'];				while($r = $con->sql_fetchassoc($q1)){					$r['do_no2'] = $report_prefix.sprintf('%05d',$r['id']);					$r['open_info'] = unserialize($r['open_info']);					$r['deliver_branch'] = unserialize($r['deliver_branch']);					$do_list[] = $r;				}								$con->sql_freeresult($q1);				$smarty->assign('do_list',$do_list);			}		}		$smarty->assign('err',$err);		$smarty->display('do.picking_verification.search.tpl');	}		function scan_item(){		global $con, $smarty, $LANG;				$form = $_REQUEST;		$id = mi($form['id']);		$bid = mi($form['branch_id']);				if(!$id || !$bid){			header("Location: do.picking_verification.php");			exit;		}				// get header info		$q1 = $con->sql_query("select * from do where id = ".mi($id)." and branch_id = ".mi($bid));		$do_info = $con->sql_fetchassoc($q1);		$con->sql_freeresult($q1);		if($do_info['do_type'] == "open") $do_type = "Cash Sales";		elseif($do_info['do_type'] == "credit_sales") $do_type = "Credit Sales";		else $do_type = $do_info['do_type'];				$_REQUEST['do_title'] = ucwords($do_type)." DO#".$_REQUEST['id']."(DD)";				// get item info		if($form['product_code']){			$product_code = strtoupper($_REQUEST['product_code']);			// cut last digit			$product_code2 = strtoupper(substr($product_code,0,strlen($product_code)-1));						$filter = array();			$filter_or[] = "(si.mcode=".ms($product_code)." or si.mcode=".ms($product_code2).")";			$filter_or[] = "(si.link_code=".ms($product_code)." or si.link_code=".ms($product_code2).")";			$filter_or[] = "(si.sku_item_code=".ms($product_code)." or si.sku_item_code=".ms($product_code2).")";			$filter_or[] = "(si.artno=".ms($product_code)." or si.artno=".ms($product_code2).")";			$filter[] = "(".join(' or ',$filter_or).")";			$filter[] = "di.do_id = ".mi($id)." and di.branch_id = ".mi($bid);			$filter = join(' and ', $filter);			$sql = $con->sql_query("select u.code as uom_code, di.ctn, di.pcs, do.deliver_branch, do.do_type, di.ctn_allocation, di.pcs_allocation, 									si.description, u2.code as packing_uom_code									from do_items di									left join do on do.id = di.do_id and do.branch_id = di.branch_id									left join sku_items si on si.id = di.sku_item_id									left join uom u on u.id = di.uom_id									left join uom u2 on u2.id = si.packing_uom_id									where $filter									limit 1");			$item_info =  $con->sql_fetchassoc($sql);			$con->sql_freeresult($sql);						$result = array();			if($item_info){				$item_info['deliver_branch'] = unserialize($item_info['deliver_branch']);				$item_info['ctn_allocation'] = unserialize($item_info['ctn_allocation']);				$item_info['pcs_allocation'] = unserialize($item_info['pcs_allocation']);				$result['data']['uom_code'] = $item_info['uom_code'];				$result['data']['description'] = $item_info['description'];				$result['data']['packing_uom_code'] = $item_info['packing_uom_code'];								// it is transfer DO and deliver to multiple branches, sum up the ctn and pcs				$total_ctn = $total_pcs = 0;				if($item_info['do_type'] == "transfer" && $item_info['deliver_branch']){					foreach($item_info['deliver_branch'] as $d_bid){						$total_ctn += $item_info['ctn_allocation'][$d_bid];						$total_pcs += $item_info['pcs_allocation'][$d_bid];					}				}else{					$total_ctn = $item_info['ctn'];					$total_pcs = $item_info['pcs'];				}				$result['data']['ctn'] = $total_ctn;				$result['data']['pcs'] = $total_pcs;			}else{				$result['not_found'] = true;			}		}		$smarty->assign("form", $_REQUEST);		$smarty->assign("result", $result);		$smarty->display("do.picking_verification.scan_item.tpl");	}}//print_r($_SESSION);$DO_Picking_Verification = new DO_Picking_Verification('DO Picking Verification');?>