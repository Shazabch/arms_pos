{*10/6/2011 2:04:32 PM Justin- Fixed the add row bugs.4/14/2015 10:12 AM Justin- Enhanced to have GST calculation.5/6/2015 5:09 PM Justin- Enhanced to have document date and GST code selection.- Enhanced to allow user key in same invoice no if having different tax codes.5/13/2015 3:28 PM Justin- Bug fixed on GST amount have been sum up wrongly.5/19/2015 11:23 AM Justin- Bug fixed on recalculate total will stop while user key in grr items from end to start.9/28/2016 10:49 AM Qiu Ying- Fix unable to key in invoice if the GRR already content DO document11/24/2017 5:20 PM Justin- Enhanced GRR not sum up DO and OTHER amounts when found having PO document.4/19/2018 5:36 PM Justin- Enhanced to have foreign currency feature.8/28/2018 3:59 PM Andy- Add SST feature.*}{literal}<style>.sh{    background-color:#ff9;}.stdframe.active{ 	background-color:#fea;	border: 1px solid #f93;}</style>{/literal}<script>var global_qty_decimal_points = '{$config.global_qty_decimal_points}';var is_under_gst = '{$form.is_under_gst|default:0}';var foreign_currency = '{$config.foreign_currency}';{literal}var total_row = 0;function hideamt(n){    document.f_a.elements["amount["+n+"]"].value=0;    document.f_a.elements["ctn["+n+"]"].value=0;    document.f_a.elements["pcs["+n+"]"].value=0;    Element.hide(document.f_a.elements["amount["+n+"]"]);    Element.hide(document.f_a.elements["ctn["+n+"]"]);    Element.hide(document.f_a.elements["pcs["+n+"]"]);    Element.hide(document.f_a.elements["gst_amount["+n+"]"]);    Element.hide(document.f_a.elements["gst_sel["+n+"]"]);    grr_recalc_row();}function showamt(n){    Element.show(document.f_a.elements["amount["+n+"]"]);    Element.show(document.f_a.elements["ctn["+n+"]"]);    Element.show(document.f_a.elements["pcs["+n+"]"]);	if(is_under_gst == 1){		Element.show(document.f_a.elements["gst_amount["+n+"]"]);		Element.show(document.f_a.elements["gst_sel["+n+"]"]);	}}function grr_add_row(n){	if(document.f_a.elements["doc_no["+(n+1)+"]"] != undefined) return;		var n = total_row++;	var new_tr = $('temp_row').cloneNode(true).innerHTML;	new_tr = new_tr.replace(/__id__/g, n);	new_tr = new_tr.replace(/__arid__/g, (n+1));	new_tr = new_tr.replace(/__rowno__/g, (n+1)+".");		// set background color for item on even	if (n%2) bgcolor = '#eee';	else bgcolor = '';	new_tr = new_tr.replace(/__bgcol__/g, bgcolor);	new Insertion.Bottom($('tb'), new_tr);		init_calendar(n);	toggle_gst_info();}function check_doc_no(idx){	var obj = document.f_a['doc_no['+idx+']'];	doc_no=trim(obj.value);		var doc_type = document.f_a['type['+idx+']'].value;		// need to exit if not PO document	if(doc_no.trim() == "" || doc_type == "" || doc_type != "PO") return;	// check if the list already have other PO	//if(foreign_currency && check_currency_po(idx) == false) return;		var params = {		'a': 'process_po_no',		doc_no: doc_no,		from_grn: 1,		grr_currency_code: document.f_a['grr_currency_code'].value	}		var q = $H(params).toQueryString();		new Ajax.Request("goods_receiving_record.php", {		parameters: q,		method: 'post',		onComplete: function(msg){			var str = msg.responseText.trim();			var ret = {};			var err_msg = '';						try{				ret = JSON.parse(str); // try decode json object								if(!ret['err']){					// found have actual po no					if(ret['new_doc_no']) obj.value = ret['new_doc_no'];										if(foreign_currency){						// got currency rate						if(ret['currency_code'] != null && ret['currency_rate'] != null){ // found foreign currency from po							document.f_a['grr_use_po_currency'].value = 1;						}else{							// always set to base currency if found have errors							document.f_a['grr_use_po_currency'].value = 0;						}					}					return;				}else{  // load currency rate failed					if(ret['err']){						err_msg = ret['err'];						obj.value = "";					}					else err_msg = str;				}			}catch(ex){ // failed to decode json, it is plain text response				err_msg = str;			}			// prompt the error			alert(err_msg);		}	});}function grr_recalc_row(){	var total = 0;	var totalctn = 0;	var totalpcs = 0;	var total_gst = 0;	var tax_register = int(document.f_a['grr_tax_register'].value);	var inv_ctn=0, inv_pcs=0, inv_amt=0, have_po=0, have_inv=0, do_ctn=0, do_pcs=0, do_amt=0, other_ctn=0, other_pcs=0, other_amt=0, inv_gst=0, do_gst=0, other_gst=0;	var e = $('tb').getElementsByClassName("doc_type[0]");	var type_length = e.length;		var total_grr_tax = 0;	var inv_tax = do_tax = other_tax = 0;	for (i=0;i<total_row;i++){		if (document.f_a.elements["amount["+i+"]"] != undefined && document.f_a.elements["doc_no["+i+"]"].value != ''){			for(var j=0; j<type_length; j++){				if(document.f_a.elements["type["+i+"]"][j].checked){					if(document.f_a.elements["type["+i+"]"][j].value == "PO"){						have_po = 1;					}if(document.f_a.elements["type["+i+"]"][j].value == "INVOICE"){						inv_ctn += float(round(document.f_a.elements["ctn["+i+"]"].value, global_qty_decimal_points));						inv_pcs += float(round(document.f_a.elements["pcs["+i+"]"].value, global_qty_decimal_points));						inv_amt += float(document.f_a.elements["amount["+i+"]"].value);						have_inv = 1;						if(document.f_a.elements["gst_amount["+i+"]"] != undefined){							inv_gst += float(document.f_a.elements["gst_amount["+i+"]"].value);						}						if(tax_register)	inv_tax += float(document.f_a.elements["tax["+i+"]"].value);					}else if(document.f_a.elements["type["+i+"]"][j].value == "DO"){						do_ctn += float(round(document.f_a.elements["ctn["+i+"]"].value, global_qty_decimal_points));						do_pcs += float(round(document.f_a.elements["pcs["+i+"]"].value, global_qty_decimal_points));						do_amt += float(document.f_a.elements["amount["+i+"]"].value);						if(document.f_a.elements["gst_amount["+i+"]"] != undefined){							do_gst += float(document.f_a.elements["gst_amount["+i+"]"].value);						}						if(tax_register)	do_tax += float(document.f_a.elements["tax["+i+"]"].value);					}else if(document.f_a.elements["type["+i+"]"][j].value == "OTHER"){						other_ctn += float(round(document.f_a.elements["ctn["+i+"]"].value, global_qty_decimal_points));						other_pcs += float(round(document.f_a.elements["pcs["+i+"]"].value, global_qty_decimal_points));						other_amt += float(document.f_a.elements["amount["+i+"]"].value);						if(document.f_a.elements["gst_amount["+i+"]"] != undefined){							other_gst += float(document.f_a.elements["gst_amount["+i+"]"].value);						}						if(tax_register)	other_tax += float(document.f_a.elements["tax["+i+"]"].value);					}				}							}		}	}		if(have_inv){		total += float(inv_amt);		totalctn += float(inv_ctn);		totalpcs += float(inv_pcs);		total_gst += float(inv_gst);		total_grr_tax += float(inv_tax);	}else if(have_po == 0){		total += float(do_amt);		totalctn += float(do_ctn);		totalpcs += float(do_pcs);		total_gst += float(do_gst);		total_grr_tax += float(do_tax);	}		if(have_po == 0){		total += float(other_amt);		totalctn += float(other_ctn);		totalpcs += float(other_pcs);		total_gst += float(other_gst);		total_grr_tax += float(other_tax);	}		document.f_a.grr_amount.value = round2(total);	document.f_a.grr_ctn.value = float(round(totalctn, global_qty_decimal_points));	document.f_a.grr_pcs.value = float(round(totalpcs, global_qty_decimal_points));	if($("grr_amount_dis") != undefined) $("grr_amount_dis").update(round2(total));	if($("grr_qty_dis") != undefined) $("grr_qty_dis").update("Ctn:"+float(round(totalctn, global_qty_decimal_points))+" / "+"Pcs:"+float(round(totalpcs, global_qty_decimal_points)));	document.f_a.grr_pcs.value = float(round(totalpcs, global_qty_decimal_points));	if(document.f_a.grr_gst_amount != undefined) document.f_a.grr_gst_amount.value = float(round(total_gst, 2));	document.f_a['grr_tax'].value = float(round(total_grr_tax, 2));	$('span_grr_tax').update(round(total_grr_tax, 2));}// check input and submit formfunction check_a(){	var i;	var count = 0;	for (i=0;i<total_row;i++)	{		if (document.f_a.elements["doc_no["+i+"]"].value == '') 		{			continue;		}		count++;		if (rdcb_empty(document.f_a.elements["type["+i+"]"], 'You must select document type'))		{			return false;		}		if (getRadioValue(document.f_a.elements["type["+i+"]"])!='PO')		{			if (empty(document.f_a.elements["amount["+i+"]"],'Please enter document\'s amount'))			{			    return false;			}		}	}	  	if (count==0)    {	    alert('You must enter at least 1 document');	    return false;	}	    document.f_a.bsubmit.disabled=true;    if (document.f_a.bdelete){    	document.f_a.bdelete.disabled=true;    }    document.f_a.submit();}function toggle_gst_info(){	var is_under_gst = document.f_a['is_under_gst'].value;	var tax_register = int(document.f_a['grr_tax_register'].value);	var gst_info = $('tb').getElementsByClassName("gst_info");	gst_info_count = gst_info.length;	if(gst_info_count > 0){		$A(gst_info).each(			function (tr,idx){				if(!is_under_gst || is_under_gst == 0){ // hide all GST info if this vendor is not under gst registered.					$(tr).style.display = "none";				}else{ // show all gst info					$(tr).style.display = "";				}			}		);	}	var gst_fields = $('tb').getElementsByClassName("gst_fields");	gst_fields_count = gst_fields.length;	if(gst_fields_count > 0){		$A(gst_fields).each(			function (tr,idx){				if(!is_under_gst || is_under_gst == 0){ // hide all GST info if this vendor is not under gst registered.					$(tr).style.display = "none";					$(tr).value = 0;				}else{ // show all gst info					$(tr).style.display = "";				}			}		);	}		// Tax Column and Field	var tax_info = $('tb').getElementsByClassName("tax_info");	tax_info_count = tax_info.length;	if(tax_info_count > 0){		$A(tax_info).each(			function (tr,idx){				if(!is_under_gst || is_under_gst == 0){ // hide all GST info if this vendor is not under gst registered.					$(tr).style.display = "";				}else{					$(tr).style.display = "none";				}			}		);	}		$$('input.grr_item_tax').each(function(inp){		if(!tax_register){			inp.value = 0;			inp.readOnly = true;		}else{			inp.readOnly = false;		}	});}function init_calendar(n){	if(n != undefined){		Calendar.setup({			inputField     :    "doc_date_"+n,			ifFormat       :    "%Y-%m-%d",			button         :    "dd_added_"+n,			align          :    "Bl",			singleClick    :    true		});	}}function check_duplicate_doc_no(n){	if(n == undefined) return;		var doc_no = document.f_a['doc_no['+n+']'].value; 	var doc_date = document.f_a['doc_date['+n+']'].value; 	var doc_type = getRadioValue(document.f_a['type['+n+']']);	var gst_id = document.f_a['gst_id['+n+']'].value;	var total=n+1;	if(total && doc_no!=''){		var is_duplicated=0, inv_err = 0;		var last_inv_no="";		for(var i=0;i<total;i++){			var tmp_doc_no = trim(document.f_a['doc_no['+i+']'].value);			var tmp_doc_type = getRadioValue(document.f_a['type['+i+']']);			var tmp_doc_date = trim(document.f_a['doc_date['+i+']'].value);			var tmp_gst_id = document.f_a['gst_id['+i+']'].value;			if(i != n){				if(tmp_doc_no==doc_no && tmp_doc_type == doc_type && tmp_gst_id == gst_id){ // found having same doc no, type and gst					is_duplicated = 1;				}			}						if(doc_type	 == "INVOICE" && tmp_doc_type == "INVOICE"){				if(last_inv_no != "" && tmp_doc_no != last_inv_no){					inv_err = 1;				}								last_inv_no = tmp_doc_no;			}		}		if(is_duplicated==1 || inv_err==1){			if(is_duplicated==1) alert("Doc No ["+doc_no+"] is existed in this GRR");			else alert("Could not have more than one Invoice at GRR");			document.f_a['doc_no['+n+']'].value='';			return false;		}	}}function on_item_gst_changed(sel, n){	document.f_a["gst_id["+n+"]"].value = "";	document.f_a["gst_code["+n+"]"].value = "";	document.f_a["gst_rate["+n+"]"].value = "";		if(sel.selectedIndex >= 0){		// got select		var opt = sel.options[sel.selectedIndex];		var gst_id = $(opt).readAttribute("gst_id");		var gst_code = $(opt).readAttribute("gst_code");		var gst_rate = $(opt).readAttribute("gst_rate");				document.f_a["gst_id["+n+"]"].value = gst_id;		document.f_a["gst_code["+n+"]"].value = gst_code;		document.f_a["gst_rate["+n+"]"].value = gst_rate;	}}</script>{/literal}<br /><h4>GRR Items</h4>{if $grr.currency_code}<font color="blue">	{if $grr.use_po_currency}		* This GRR contains foreign currency inherited from PO, therefore amendments to add or remove document for PO is not allowed.<br />	{else}		* This GRR contains foreign currency, therefore PO with foreign currency is required in order to add into the GRR item.<br />	{/if}</font>{/if}<input type="hidden" name="a" value="grr_save"><input type="hidden" name="grr_id" value="{$form.grr_id}"><input type="hidden" name="branch_id" value="{$form.branch_id|default:$sessioninfo.branch_id}"><input type="hidden" name="user_id" value="{$form.user_id|default:$sessioninfo.id}"><input type="hidden" name="grn_amount" value="{$form.amount}"><input type="hidden" name="grr_amount" value="{$form.grr_amount}"><input type="hidden" name="grr_ctn" value="{$form.grr_ctn}"><input type="hidden" name="grr_pcs" value="{$form.grr_pcs}"><input type="hidden" name="grr_gst_amount" value="{$form.grr_gst_amount}" class="gst_fields"><input type="hidden" name="grr_use_po_currency" value="{$grr.use_po_currency}"><input type="hidden" name="grr_currency_code" value="{$grr.currency_code}"><input type="hidden" name="grr_currency_rate" value="{$grr.currency_rate}"><input type="hidden" name="grr_tax_register" value="{$grr.tax_register}"><table id="tb" cellpadding="4" cellspacing="1" border="0" style="padding:1px;border:1px solid #000"><tr bgcolor="#ffee99" class="small">	<th rowspan="2">&nbsp;</th>	<th rowspan="2">Reference No</th>	<th rowspan="2">Document Date</th>	<th colspan="4">Document Type</th>	<th rowspan="2">Received<br>Carton</th>	<th rowspan="2">Received<br>Pcs</th>	<th rowspan="2">Amount<br />Incl Tax</th>	<th rowspan="2" class="gst_info">GST Amount</th>	<th rowspan="2" class="gst_info">GST Code</th>	<th rowspan="2" class="tax_info">Tax Amount</th>	<th rowspan="2">Remark</th></tr><tr bgcolor="#ffee99" class="small">	<th width="50">PO</td>	<th width="50">INVOICE</td>	<th width="50">DO</td>	<th width="50">OTHER</td></tr>{assign var=idx value=0}{foreach from=$form.grr_items key=n item=item name=grr_item}{if $item.doc_no[$n] ne '' or $item.amount}<tr id="tr_{$idx}" bgcolor="{if $errm[$n]}#ff9999{else}{cycle name='r0' values=',#eeeeee'}{/if}">	<td nowrap>		{$idx+1}.		{if $item.id && (($item.type ne 'PO' && $grr.currency_code && $grr.use_po_currency) || !$grr.currency_code)}			<img src="/ui/remove16.png" valign="absmiddle" class="clickable" onclick="if (confirm('Are you sure?')) {literal}{{/literal} $('doc_{$idx}').value='';Element.hide('tr_{$idx}');grr_recalc_row();{literal}}{/literal}" title="delete row">		{/if}	</td>	<td>		<input type="hidden" name="grr_item_id[{$idx}]" value="{$item.id}">		{if $item.type eq 'PO' && $item.id}			<input type="hidden" name="curr_po_no[{$idx}]" value="{$item.curr_po_no}">		{/if}		<input id="doc_{$idx}" name="doc_no[{$idx}]" value="{$item.doc_no}" size="15" onchange="uc(this); grr_add_row({$idx}); check_doc_no({$idx}); check_duplicate_doc_no({$idx}); grr_recalc_row();" maxlength="20">	</td>	<td nowrap>		<input name="doc_date[{$idx}]" id="doc_date_{$idx}" value="{$item.doc_date|ifzero:''}" maxlength="10" size="8" readonly>		<img align="absmiddle" src="ui/calendar.gif" id="dd_added_{$idx}" style="cursor: pointer;" title="Select Document Date">		<script>init_calendar('{$idx}');</script>	</td>	<td align="center">		<input type="radio" class="doc_type[{$idx}]" onclick="hideamt({$idx}); check_doc_no({$idx}); grr_recalc_row(); check_duplicate_doc_no({$idx});" name="type[{$idx}]" value="PO" {if $item.type eq 'PO'}checked{/if} {if $item.type ne 'PO' && $grr.currency_code && $grr.use_po_currency}disabled{/if}>	</td>	<td align="center">		<input type="radio" class="doc_type[{$idx}]" onclick="showamt({$idx}); grr_recalc_row(); check_duplicate_doc_no({$idx});" name="type[{$idx}]" value="INVOICE" {if $item.type eq 'INVOICE'}checked{/if} {if $item.type eq 'PO' && $grr.currency_code && $grr.use_po_currency}disabled{/if}>	</td>	<td align="center">		<input type="radio" class="doc_type[{$idx}]" onclick="showamt({$idx}); grr_recalc_row(); check_duplicate_doc_no({$idx});" name="type[{$idx}]" value="DO" {if $item.type eq 'DO'}checked{/if} {if $item.type eq 'PO' && $grr.currency_code && $grr.use_po_currency}disabled{/if}>	</td>	<td align="center">		<input type="radio" class="doc_type[{$idx}]" onclick="showamt({$idx}); grr_recalc_row(); check_duplicate_doc_no({$idx});" name="type[{$idx}]" value="OTHER" {if $item.type eq 'OTHER'}checked{/if} {if $item.type eq 'PO' && $grr.currency_code && $grr.use_po_currency}disabled{/if}>	</td>	<td><input name="ctn[{$idx}]" value="{$item.ctn}" onchange="this.value=float(round(this.value, {$config.global_qty_decimal_points})); grr_recalc_row();" size="7" class="r" {if $item.type eq 'PO'}style="display:none"{/if}></td>	<td><input name="pcs[{$idx}]" value="{$item.pcs}" onchange="this.value=float(round(this.value, {$config.global_qty_decimal_points})); grr_recalc_row();" size="7" class="r" {if $item.type eq 'PO'}style="display:none"{/if}></td>	<td><input name="amount[{$idx}]" value="{$item.amount}" onchange="mf(this); grr_recalc_row();" size="10" maxlength="10" class="r" {if $item.type eq 'PO'}style="display:none"{/if}></td>	<td class="gst_info"><input name="gst_amount[{$idx}]" value="{$item.gst_amount}" onchange="mf(this); grr_recalc_row();" size="10" maxlength="10" class="r" {if $item.type eq 'PO'}style="display:none"{/if}></td>	<td class="gst_info">		<select name="gst_sel[{$idx}]" onchange="on_item_gst_changed(this, {$idx}); check_duplicate_doc_no({$idx});">			{foreach from=$gst_list key=rid item=gst}				<option value="{$gst.id}" gst_id="{$gst.id}" gst_code="{$gst.code}" gst_rate="{$gst.rate}" {if $item.gst_id eq $gst.id and $item.gst_code eq $gst.code and $item.gst_rate eq $gst.rate}selected {/if}>{$gst.code} ({$gst.rate}%)</option>			{/foreach}		</select>		<input type="hidden" name="gst_id[{$idx}]" value="{$item.gst_id|default:$gst_list.0.id}" />		<input type="hidden" name="gst_code[{$idx}]" value="{$item.gst_code|default:$gst_list.0.code}" />		<input type="hidden" name="gst_rate[{$idx}]" value="{$item.gst_rate|default:$gst_list.0.rate}" />	</td>	<td class="tax_info">		<input name="tax[{$idx}]" value="{$item.tax}" onchange="mf(this); grr_recalc_row();" size="10" maxlength="10" class="r grr_item_tax" {if $item.type eq 'PO'}style="display:none"{/if} />	</td>	<td><input size="50" class="small" name="remark[{$idx}]" value="{$item.remark}"></td></tr><script>total_row = {$idx+++1};</script>{if $errm[$n]}<tr><td>&nbsp;</td><td colspan="8" class="errmsg"><font class="small">{foreach from=$errm[$n] item=e}&middot; {$e}<br>{/foreach}</font></td></tr>{/if}{/if}{/foreach}</table><p align="center"><input id="submitbtn" name="bsubmit" type="button" value="Save GRR" style="font:bold 20px Arial; background-color:#f90; color:#fff;" onclick="check_a();"><input type=button name="close" value="Close" style="font:bold 20px Arial; background-color:#09f; color:#fff;" onclick="do_close();"></p>{literal}<script>grr_add_row();grr_recalc_row();toggle_gst_info();//new Draggable('available_po');</script>{/literal}