{*1/3/2013 5:37 PM Justin- Enhanced to have cancel function.1/16/2013 10:22 AM Justin- Enhanced to have sorting feature by Category or SKU.- Enhanced to show category column.1/18/2013 10:50 AM Justin- Enhanced to hide department dropdown list and become hidden field.1/18/2013 4:49 PM Justin- Enhanced to show department.1/21/2013 10:59 AM Justin- Bug fixed on showing wrong info of GRN status.- Enhanced to have pre-confirm feature.2/1/2013 6:01 PM Justin- Enhanced to include old code column.*}{include file=header.tpl}<link rel="stylesheet" type="text/css" media="all" href="js/jscalendar/calendar-blue.css" title="calendar-blue" /><script type="text/javascript" src="js/jscalendar/calendar.js"></script><script type="text/javascript" src="js/jscalendar/lang/calendar-en.js"></script><script type="text/javascript" src="js/jscalendar/calendar-setup.js"></script>{literal}<style>.sh{    background-color:#ff9;}.stdframe.active{ 	background-color:#fea;	border: 1px solid #f93;}.tbl_item input, .tbl_item select{	border:1px solid #999;	font-size: 10px;	padding:2px;}input[disabled], input[readonly], select[disabled], textarea[disabled]{	color:black;	background:white;}.tbl_item thead tr{	height: 30;	background: #ffffff;	font-size: 80%;}</style>{/literal}<script>var phpself = '{$smarty.server.PHP_SELF}';var action = '{$smarty.request.a}';{literal}var GRN = {	f: undefined,	initialize: function(){		this.f = document.f_a;				// initial calendar		Calendar.setup({			inputField     :    "rcv_date",     // id of the input field			ifFormat       :    "%Y-%m-%d",      // format of the input field			button         :    "img_rcv_date",  // trigger for the calendar (button ID)			align          :    "Bl",           // alignment (defaults to "Bl")			singleClick    :    true		});				this.recalc_total();	},		form_submit: function(type){		if (!confirm(type+' GRN?')) return;		this.f['a'].value = type;		this.f.submit();	},		pre_confirm_stage: function(type){		if(type == 'confirm'){			//this.f['preconfirm'].hide();			//this.f['confirm'].show();			//this.f['back'].show();			$('pre_confirm').hide();			$('final_confirm').show();						var total_rows = $('tbl_item').getElementsByClassName("titem");			var total_rows_length = total_rows.length;						if(total_rows_length > 0){				$A(total_rows).each(					function (r,idx){						var ri = r.id.split("_");						var id = ri[1];						var qty = document.f_a['qty['+id+']'].value;												if(qty == 0 || !qty) $('titem_'+id).hide();					}				);				this.reset_row_no(1);			}		}else{			$('pre_confirm').show();			$('final_confirm').hide();			var total_rows = $('tbl_item').getElementsByClassName("titem");			var total_rows_length = total_rows.length;						if(total_rows_length > 0){				$A(total_rows).each(					function (r,idx){						var ri = r.id.split("_");						var id = ri[1];						var qty = document.f_a['qty['+id+']'].value;												if(qty == 0 || !qty) $('titem_'+id).show();					}				);				this.reset_row_no(0);			}		}	},		recalc_row: function(id){		var cost_price = this.f['cost_price['+id+']'].value;		var qty = this.f['qty['+id+']'].value;		var amount = round(float(cost_price) * float(qty), 2);		this.recalc_total();	},		reset_row_no: function(filter_hidden){		var total_rows = $('tbl_item').getElementsByClassName("titem");		var total_rows_length = total_rows.length;		var row_count = 0;				if(total_rows_length > 0){			$A(total_rows).each(				function (r,idx){					var ri = r.id.split("_");					var id = ri[1];					var qty = document.f_a['qty['+id+']'].value;										if(qty > 0 && filter_hidden){						row_count++;						$('no_'+id).update(row_count+".");					}else if(filter_hidden == 0){						row_count++;						$('no_'+id).update(row_count+".")					}				}			);		}	},		recalc_total: function(){		var total_rows = $('tbl_item').getElementsByClassName("titem");		var total_rows_length = total_rows.length;		var total_qty = 0;		var total_amount = 0;		var total_selling = 0;				if(total_rows_length > 0){			$A(total_rows).each(				function (r,idx){					var ri = r.id.split("_");					var id = ri[1];					var cost_price = document.f_a['cost_price['+id+']'].value;					var selling_price = document.f_a['selling_price['+id+']'].value;					var qty = document.f_a['qty['+id+']'].value;					var amount = round(float(cost_price) * float(qty), 2);					var sell_amount = round(float(selling_price) * float(qty), 2);					$('amount_'+id).update(amount);					total_qty += float(qty);					total_amount += float(amount);					total_selling += float(sell_amount);				}			);			$('total_qty').update(total_qty);			this.f['total_qty'].value = total_qty;			$('total_amount').update(round(total_amount, 2));			this.f['total_amount'].value = total_amount;			this.f['total_selling'].value = total_selling;		}	},		do_close: function(){		if (!confirm('Discard changes and close?')) return;		document.location = 'vp.goods_receiving_note.php';	},		sort_type_changed: function(obj){		if(action == "view"){			document.f_b['sort_by'].value = document.f_a['sort_by'].value;			var form_element = Form.serialize(document.f_b);		}else var form_element = Form.serialize(document.f_a);		$('loading').show();		new Ajax.Request(phpself, {			method:'post',			parameters: form_element+'&a=ajax_refresh_items_list',			evalScripts: true,			onFailure: function(m) {				alert(m.responseText);			},			onSuccess: function(m) {				$('loading').hide();			},			onComplete: function(m) {				$('grn_items').update();				var str = m.responseText.trim();				//var ret = {};			    var err_msg = '';									//ret = JSON.parse(str); // try decode json object				eval("var json = "+m.responseText);				for(var tr_key in json){					if(json[tr_key]['html']){ // success						new Insertion.Bottom('grn_items', json[tr_key]['html']);					}				}			    // prompt the error			    if(err_msg) alert(err_msg);				GRN.recalc_total();			}		});	}};{/literal}</script><h1>	Goods Receiving Note {if $form.id}(ID#{$form.id}){else}(New){/if}	{if $form.id}		<h3>Status:			{if !$form.active}				Cancelled			{elseif $form.approved eq 1}				Confirmed			{else}				Draft			{/if}		</h3>	{/if}</h1>{include file=approval_history.tpl}{if $errm}<div id="err"><div class="errmsg"><ul>{foreach from=$errm item=e}<li> {$e}{/foreach}</ul></div></div>{/if}<form name="f_b" method="post" action="{$smarty.server.PHP_SELF}"><input type="hidden" name="a" value="save" /><input type="hidden" name="action" value="{$smarty.request.a}" /><input type="hidden" name="id" value="{$form.id}" /><input type="hidden" name="grr_id" value="{$form.grr_id}" /><input type="hidden" name="branch_id" value="{$form.branch_id|default:$vp_session.branch_id}" /><input type="hidden" name="approval_history_id" value="{$form.approval_history_id}" /><input type="hidden" name="sort_by" value="{$view_type}" /></form><form name="f_a" method="post" action="{$smarty.server.PHP_SELF}"><input type="hidden" name="a" value="save" /><input type="hidden" name="action" value="{$smarty.request.a}" /><input type="hidden" name="id" value="{$form.id}" /><input type="hidden" name="grr_id" value="{$form.grr_id}" /><input type="hidden" name="department_id" value="{$form.department_id|default:0}" />{assign var=department_id value=$form.department_id|default:0}<input type="hidden" name="branch_id" value="{$form.branch_id|default:$vp_session.branch_id}" /><input type="hidden" name="approval_history_id" value="{$form.approval_history_id}" /><br><div class="stdframe" style="background:#fff"><h4>General Information</h4><table  border="0" cellspacing="0" cellpadding="4">	<tr>		<td><b>Received Date</b></td>		<td>			<input type="text" name="rcv_date" id="rcv_date" value="{$form.rcv_date}" size="12">			{if !$is_view_mode}				<img align="absmiddle" src="ui/calendar.gif" id="img_rcv_date" style="cursor: pointer;" title="Select Received Date" />			{/if}		</td>		<!--td><b>Department</b></td>		<td colspan="3">			<select name="department_id">				{foreach from=$departments item=dept}					<option value="{$dept.id}" {if $form.department_id eq $dept.id}selected{/if} >{$dept.description}</option>				{/foreach}			</select>		</td-->	</tr>	{if $form.id}	<tr>		<td><b>GRR No</b></td><td>GRR{$form.grr_id|string_format:"%05d"}</td>		<td><b>Branch</b></td><td>{$form.branch_code}</td>	</tr>	<tr>		<td><b>GRR Date</b></td><td>{$form.added|date_format:$config.dat_format}</td>		<td><b>Department</b></td><td>{$departments.$department_id.description|default:'-'}</td>	</tr>	<tr>		<td><b>GRR Amount</b></td>		<td><div id="grr_amount_dis">{$form.grr_amount|number_format:2}</div></td>		<td><b>Received Qty</b></td>		<td><div id="grr_qty_dis">Ctn:{$form.grr_ctn|qty_nf} / Pcs:{$form.grr_pcs|qty_nf}</div></td>	</tr>	<tr>		<td width="100" valign="top"><b>Document No.</b></td>		<td width="150" valign="top"><font color="blue">{$form.doc_no}</font></td>		<td width="100" valign="top"><b>Document Type</b></td>		<td width="100" valign="top"><font color="blue">{$form.type}</font></td>	</tr>	{/if}	{*if $config.grn_have_tax}		<tr>			<td><b>Tax</b></td>			<td colspan="3"><input type="text" name="grn_tax" value="{$form.grn_tax}" class="r" size="5" /> %</td>		</tr>	{/if*}</table></div><span id="span_autocomplete_adding" style="padding:2px;background:yellow;display:none;"><img src="ui/clock.gif" align="absmiddle" /> Adding... Please wait</span><div id="div_sort_area">	<br />	<b>Sort by</b>	<select name="sort_by" onchange="GRN.sort_type_changed(this);">		{foreach from=$sort_type key=val item=desc}			<option value="{$val}">{$desc}</option>		{/foreach}	</select>	<span id="loading" style="display:none;"><img src="ui/clock.gif" align="absmiddle"> Loading...</span></div><h2>Items</h2><table width="100%" id="tbl_item" style="border:1px solid #999; padding:5px; background-color:#fe9" class="tbl_item input_no_border body" cellspacing="1" cellpadding="4">	<thead>		<tr>			<th>#</th>			<th>ARMS Code</th>			<th>Artno</th>			<th>Mcode</th>			<th>Old Code</th>			<th width="80%">Description</th>			<th>Category</th>			<th>Cost Price</th>			<th>Order Qty<br />(Pcs)</th>			<th>Amount</th>		</tr>	</thead>	<tbody id="grn_items" class="multiple_add_container">	{foreach from=$grn_items item=item name=fitem}		<tr bgcolor="#ffee99" onmouseover="this.bgColor='#ffffcc';" onmouseout="this.bgColor='';" class="titem" id="titem_{$item.id}">			{include file=vp.goods_receiving_note.new.row.tpl}		</tr>	{foreachelse}		<tr>			<td colspan="9" align="center">- No Data -</td>		</tr>	{/foreach}	</tbody>	<tfoot>		<tr bgcolor=#ffffff>			<th colspan="8" align="right">Total</th>			<th class="r" id="total_qty">&nbsp;</th>			<th class="r" id="total_amount">&nbsp;</th>			<input type="hidden" name="total_qty" value="" />			<input type="hidden" name="total_amount" value="" />			<input type="hidden" name="total_selling" value="" />		</tr></tfoot></table><p align="center" id="pre_confirm">{if !$form.approved}	<input type="button" name="save" value="Save" style="font:bold 20px Arial; background-color:#f90; color:#fff;" onclick="GRN.form_submit('save');">	<input type="button" name="preconfirm" value="Confirm" style="font:bold 20px Arial; background-color:#090; color:#fff;" onclick="GRN.pre_confirm_stage('confirm');">	{if $form.id}		<input type="button" name="cancel" value="Cancel" style="font:bold 20px Arial; background-color:#900; color:#fff;" onclick="GRN.form_submit('cancel');">	{/if}{/if}<input type="button" name="close" value="Close" style="font:bold 20px Arial; background-color:#09f; color:#fff;" onclick="GRN.do_close();"></p><p align="center" id="final_confirm" style="display:none;">	<input type="button" name="back" value="Back" style="font:bold 20px Arial; background-color:#950; color:#fff;" onclick="GRN.pre_confirm_stage('cancel');">	<input type="button" name="confirm" value="Final Confirm" style="font:bold 20px Arial; background-color:#090; color:#fff;" onclick="GRN.form_submit('confirm');"></p></form><script>{literal}GRN.initialize();{/literal}{if $is_view_mode}	Form.disable(document.f_a);	document.f_a['sort_by'].disabled = false;	document.f_a['close'].disabled = false;{/if}</script>{include file=footer.tpl}