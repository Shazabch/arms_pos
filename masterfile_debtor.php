<?/*8/5/2009 5:12:35 PM Andy- need to add privilege- insert into privilege values('MST_DEBTOR','Debtor Master File',1,0)5/14/2010 6:08:10 PM Alex- add area7/11/2011 4:03:45 PM Andy- Replace htmlentities() to htmlspecialchars()12/7/2012 3:27:00 PM Fithri- add description and alphabet filter4/1/2013 4:03 PM Andy- Allow to generate login ticket for debtor if got config "enable_debtor_portal".5/13/2013 10:11 AM Andy- Add default mprice type for debtor.5/27/2013 2:14 PM Andy- Check maintenance version 201.10/1/2013 6:01 PM Fithri- make all email field not compulsary- when sending email, check to trigger send function only when email is set10/23/2013 9:47 AM Fithri- records is now displayed in pages, 20 per page- re-arrange default filters behaviours1/24/2015 4:12 PM Justin- Enhanced search engine to search debtor code as well.1/26/2015 5:58 PM Andy- Add Special Exemption for Debtor.11/1/2016 11:41 AM Andy- Enhanced to have debtor gst start date and gst registration number.11/1/2016 1:44 PM Andy- Check maintenance version 300.2017-08-25 15:08 PM Qiu Ying- Enhanced to add Debtor blocklist for Credit Sales DO at debtor masterfile2017-09-13 10:41 AM Qiu Ying- Bug fixed on treating special characters as wildcard character12/1/2017 11:33 AM Justin- Enhanced to have "Address (Deliver)".12/12/2017 3:25 PM Andy- Increase maintenance version checking to 341.3/30/2018 4:13PM HockLee- Add Integration Code to map branch and debtor.8/15/2018 2:40 PM Andy- Increase maintenance version checking to 356.8/23/2018 1:59 PM Andy- Enhanced to have capture log when update debtor.- Enhanced to have Debtor Price selection.- Increase maintenance version checking to 360.5/3/2019 10:05 AM Liew- Add default Sales Agent*/include("include/common.php");if (!$login) js_redirect($LANG['YOU_HAVE_LOGGED_OUT'], "/index.php");if (!privilege('MASTERFILE')) js_redirect(sprintf($LANG['NO_PRIVILEGE'], 'MASTERFILE', BRANCH_CODE), "/index.php");if (!privilege('MST_DEBTOR')) js_redirect(sprintf($LANG['NO_PRIVILEGE'], 'MST_DEBTOR', BRANCH_CODE), "/index.php");if(!$config['do_allow_credit_sales'])	js_redirect(sprintf($LANG['DO_CREDIT_SALES_NOT_ALLOWED'], 'DO', BRANCH_CODE), "/index.php");$maintenance->check(360);$smarty->assign("PAGE_TITLE", "Debtor Master File");init_table();if (isset($_REQUEST['a'])){	switch ($_REQUEST['a'])	{		case 'save_blocklist':			$form=$_REQUEST;			$id=$form['debtor_id'];			$tbl_col=array('credit_sales_do_block_list');            $con->sql_query("update debtor set ".$tbl_col[0]."='' where id=" .mi($id));			if ($form['block']){				foreach ($form['block']	as $no => $type_block_list){					$sblock = serialize($type_block_list);	                $con->sql_query("update debtor set ".$tbl_col[$no]."='$sblock' where id=" .mi($id));				}			} 			print "OK";			exit;		case 'load_blocklist':			$form=$_REQUEST;			$type=array('Credit Sales DO');			$id=$form['debtor_id'];		    $con->sql_query("select description, credit_sales_do_block_list from debtor where id = " . mi($id));						while($r = $con->sql_fetchassoc()){				$block[] = unserialize($r['credit_sales_do_block_list']);				$form['debtor']=$r['description'];			}			$con->sql_freeresult();			$con->sql_query("select id, code, description from branch");			while($r1 = $con->sql_fetchassoc()){				$branches[] = $r1;			}			$con->sql_freeresult();			$smarty->assign("branches", $branches);			$smarty->assign("form", $form);			$smarty->assign("type", $type);			$smarty->assign("block", $block);			$smarty->display("masterfile_debtor.blocklist.tpl");			exit;	    case 'open':	        open();	        exit;		case 'save':		    save();		    exit;		case 'reload_table':		    reload_table();		    exit;		case 'toggle_status':		    toggle_status();		    exit;		case 'ajax_search_area':            ajax_search_area();            exit;		default:			print "<h3>Unhandled Request</h3>";			print_r($_REQUEST);			exit;	}}reload_table(true);$smarty->display("masterfile_debtor.tpl");function init_table(){ /* moved to maintenance.php */ }function reload_table($sqlonly = false){	global $con, $smarty,$sessioninfo;		/*	if (isset($_REQUEST['alphabate'])) {		$o = strval($_REQUEST['alphabate']);		if ($o == 'all') $where_arr[] = '1';		elseif ($o == 'inactive') $where_arr[] = 'active=0';		elseif ($o == 'others') $where_arr[] = "description < 'A' or description > 'Zz'";		else $where_arr[] = "description like " .ms($o.'%');	}	elseif (isset($_REQUEST['search'])) {		$desc = ms('%'.$_REQUEST['search'].'%');		$where_arr[] = "description like $desc";	}	else {		$where_arr[] = 'active=0';	}	*/	$filter = array();		// search code and description	if ($_REQUEST['desc']) {		$desc = replace_special_char($_REQUEST['desc']);		$filter[] = "(d.description like ".ms('%'.$desc.'%')." or d.code like ".ms('%'.$desc.'%').")";	}	if (isset($_REQUEST['status']) && $_REQUEST['status'] != '') {		$filter[] = "d.active = ".mi($_REQUEST['status']);	}	if ($_REQUEST['starts_with']) {		if ($_REQUEST['starts_with'] == 'others') $filter[] = "d.description < 'A' or d.description > 'Zz'";		else $filter[] = "d.description like ".ms($_REQUEST['starts_with'].'%');	}	$filter_str = $filter ? 'where '.join(' and ', $filter) : '';		$start_at = $_REQUEST['pg'] ? mi($_REQUEST['pg'])-1 : 0;	$start_at = $start_at*20;		$sql = "select * from debtor d $filter_str order by description limit $start_at,20";	$con->sql_query($sql) or die(mysql_error());	$table = $con->sql_fetchrowset();	$smarty->assign("table", $table);		$sql = "select count(*) as c from debtor d $filter_str";	$con->sql_query($sql) or die(mysql_error());	$rows = $dcount = mi($con->sql_fetchfield(0));	$smarty->assign("dcount", $dcount);		$pagination = '';	for ($p=1; $rows>0; $p++) {		$selected = ($p == mi($_REQUEST['pg'])) ? 'selected' : '';		$pagination .= "<option $selected value=\"$p\">$p</option>";		$rows -= 20;	}	$smarty->assign("total_page", --$p);	$smarty->assign("pagination", $pagination);		if (!$sqlonly) $smarty->display("masterfile_debtor.table.tpl");}function open(){	global $con,$smarty;	$id = intval($_REQUEST['id']);		$q1 = $con->sql_query("select id, code, name from sa") or die (mysql_error());			while($result = $con->sql_fetchassoc($q1)){		$sales_agent[] = $result;	}	$con->sql_freeresult($q1);		// open an existing data	if($id>0){		// load header		$con->sql_query("select * from debtor where id=$id") or die(mysql_error());		$form = $con->sql_fetchrow();		if(!$form){			print "Error: Invalid Debtor ID";			exit;		}	}		$smarty->assign('sales_agent', $sales_agent);	$smarty->assign('form',$form);	$smarty->display('masterfile_debtor.open.tpl');}function save(){	global $con,$smarty,$sessioninfo,$config;	$id = intval($_REQUEST['id']);	$upd = array();		//check for error and store data in upd	$err = validate_data($upd);	if($err){		print $err; // got error		exit;	}	// no error found, start update or insert	if($id>0){  // exists data, do update		$con->sql_query("update debtor set ".mysql_update_by_field($upd)." where id=$id") or die(mysql_error());	}else{  // new data, do insert        $con->sql_query("insert into debtor ".mysql_insert_by_field($upd)) or die(mysql_error());        $id = $con->sql_nextid();        $is_new = true;	}		// got debtor portal	if($config['enable_debtor_portal']){		$login_ticket = trim($_REQUEST['login_ticket']);				// got login ticket		if($login_ticket){			$con->sql_query("update debtor set login_ticket=".ms($login_ticket)." where id=$id");		}else{			if(!$is_new){				$con->sql_query("update debtor set login_ticket=null where id=$id");				}		}	}	// integration code	if($config['enable_reorder_integration']){		$integration_code = trim($_REQUEST['integration_code']);				// got integration code		if($integration_code){			$con->sql_query("update debtor set integration_code=".ms($integration_code)." where id=$id");		}else{			if(!$is_new){				$con->sql_query("update debtor set integration_code='' where id=$id");				}		}	}		log_br($sessioninfo['id'], 'MASTERFILE', $id, "Debtor ID#$id information updated");		print "OK";}function validate_data(&$upd){	global $con,$sessioninfo, $config;		$id = intval($_REQUEST['id']);		$upd['code'] = trim($_REQUEST['code']);	$upd['description'] = trim($_REQUEST['description']);	$upd['company_no'] = trim($_REQUEST['company_no']);	$upd['address'] = trim($_REQUEST['address']);	$upd['area'] = trim($_REQUEST['area']);	$upd['phone_1'] = trim($_REQUEST['phone_1']);	$upd['phone_2'] = trim($_REQUEST['phone_2']);	$upd['phone_3'] = trim($_REQUEST['phone_3']);	$upd['contact_person'] = trim($_REQUEST['contact_person']);	$upd['contact_email'] = trim($_REQUEST['contact_email']);	$upd['term'] = mi($_REQUEST['term']);	$upd['credit_limit'] = mf($_REQUEST['credit_limit']);	$upd['debtor_mprice_type'] = trim($_REQUEST['debtor_mprice_type']);	$upd['sa_id'] = trim($_REQUEST['debtor_sales_agent']);	$upd['last_update'] = 'CURRENT_TIMESTAMP';	$upd['special_exemption'] = mi($_REQUEST['special_exemption']);	$upd['account_receivable_code'] = trim($_REQUEST['account_receivable_code']);	$upd['account_receivable_name'] = trim($_REQUEST['account_receivable_name']);	$upd['delivery_address'] = trim($_REQUEST['delivery_address']);	$upd['use_debtor_price'] = mi($_REQUEST['use_debtor_price']);	if($config['enable_gst']){		$upd['gst_register_no'] = trim($_REQUEST['gst_register_no']);		$upd['gst_start_date'] = trim($_REQUEST['gst_start_date']);	}		if(!$upd['code'])   return 'Please enter code';	if ($upd['contact_email'] && !preg_match(EMAIL_REGEX, $upd['contact_email'])) return 'Invalid e-mail address';		// check duplicate code	$con->sql_query("select count(*) from debtor where code=".ms($upd['code'])." and id<>$id") or die(mysql_error());	if($con->sql_fetchfield(0)>0)   return "code '$upd[code]' already used.";		if($config['enable_debtor_portal']){		$login_ticket = trim($_REQUEST['login_ticket']);				// got login ticket		if($login_ticket){			$con->sql_query("select id from debtor where login_ticket=".ms($login_ticket)." and id<>$id");			$tmp = $con->sql_fetchassoc();			$con->sql_freeresult();						if($tmp)	return "The debtor key already used, please generate another debtor key.";		}	}	if($config['enable_reorder_integration']){		$integration_code = trim($_REQUEST['integration_code']);				// got integration code		if($integration_code){			$con->sql_query("select id from debtor where integration_code=".ms($integration_code)." and id<>$id");			$int_code = $con->sql_fetchassoc();			$con->sql_freeresult();						if($int_code)	return "The integration code already used, please generate another integration code.";		}	}}function toggle_status(){	global $con;		$id = mi($_REQUEST['id']);	$status = mi($_REQUEST['status']);		$con->sql_query("update debtor set active=$status where id=$id") or die(mysql_error());		//header("Location: $_SERVER[PHP_SELF]?a=reload_table");}function ajax_search_area(){    global $con, $smarty;        $v = trim($_REQUEST['value']);    $LIMIT = 50;    // call with limit	$result1 = $con->sql_query("select distinct(area) as area 		from debtor 		where area like ".ms('%'.replace_special_char($v).'%')." 		union 		select distinct(name) as area 		from transporter_area 		where name like ".ms('%'.replace_special_char($v).'%')." and active = 1 		order by area limit ".($LIMIT+1));    print "<ul>";	if ($con->sql_numrows($result1) > 0)	{	    if ($con->sql_numrows($result1) > $LIMIT)	    {			print "<li><span class=informal>Showing first $LIMIT area...</span></li>";		}		// generate list.		while ($r = $con->sql_fetchrow($result1))		{			$out .= "<li title=".htmlspecialchars($r['area'])."><span>".htmlspecialchars($r['area']);			$out .= "</span>";			$out .= "</li>";		}    }    else    {       print "<LI title=\"0\"><span class=informal>No Matches for $v</span></LI>";	}	print $out;    print "</li>";	exit;}?>