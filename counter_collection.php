<?php/*3/19/2010 3:46:44 PM edward- add remote pos server11/1/2010 1:58:08 PM yinsee- set time limit 01/13/2011 2:09:23 PM Andy- Add checking if found $config['counter_collection_server'] will popup windows to use remote server.2/28/2011 2:45:57 PM Andy- Fix counter collection open in data center bugs. (date not pass when redirect)3/31/2011 6:17:51 PM Andy- Add checking if the file is called by AJAX, add a notice and let the request process, no need to redirect/popup new window.4/11/2011 11:59:41 AM Andy- Add counter_collection.include.php10/24/2011 9:58:42 AM Andy- Increase maintenance version checking.10/27/2011 11:36:20 AM Andy- Fix counter collection cannot print transaction receipt from data center.6/22/2012 4:44:00 PM Andy- Raise maintenance version to 130.1/24/2013 2:48 PM Andy- Raise maintenance version to 183.8/27/2013 4:51 PM Andy- Raise maintenance version to 209.2/13/2014 10:17 AM Fithri- raise maintenance version to 2179/11/2014 2:37 PM Justin- Enhanced to remove off the config "counter_collection_simple" checking.11/23/2016 10:00 AM Andy- Raise maintenance checking version to 302.3/3/2017 4:44 PM Andy- Raise maintenance checking version to 311.4/10/2017 10:06 AM Andy- Raise maintenance checking version to 314.10/6/2017 10:53 AM Andy- Raise maintenance checking version to 320.12/7/2017 10:45 AM Andy- Raise maintenance checking version to 338.10/15/2018 3:49 PM Andy- Raise maintenance checking version to 365.*/set_time_limit(0);if (isset($_REQUEST['remote'])==1){	// clear login_branch cookie	setcookie('arms_login_branch', '');	unset($_COOKIE['arms_login_branch']);}include("include/common.php");$maintenance->check(365);if (isset($_REQUEST['remote'])==1){	$_SESSION[$_SERVER['HTTP_HOST']]['is_remote'] = 1;	$uid = mi($_REQUEST['id']);	$bid = mi($_REQUEST['branch']);	// make sure user can login this branch	$con->sql_query("select * from user_privilege where user_id=$uid and branch_id=$bid and privilege_code='LOGIN'");	$user = $con->sql_fetchrow();		if (!$user) { die("You do not have permission."); }    $con->sql_query("delete from session where ssid = ".ms($ssid));	$con->sql_query("replace into session (user_id, ssid) values ($uid, ".ms($ssid).")");	// set login branch and redirect	setcookie('arms_login_branch', get_branch_code($bid));	if(isset($_REQUEST['redirect_path']))  $redir_path = $_REQUEST['redirect_path'];	else{        $redir_path = $_SERVER['PHP_SELF'];        //print_r($_REQUEST);        if(isset($_REQUEST['redir']))	$redir_path = $_REQUEST['redir'];        elseif(isset($_REQUEST['date_select'])) $redir_path .= "?date_select=".$_REQUEST['date_select'];	}	header("Location: $redir_path");	exit;}if (!is_ajax()){	if (!$login) js_redirect($LANG['YOU_HAVE_LOGGED_OUT'], "/index.php");	if (!privilege('POS_BACKEND') && !privilege('CC_FINALIZE') && !privilege('CC_UNFINALIZE')) js_redirect(sprintf($LANG['NO_PRIVILEGE'], 'POS_BACKEND or CC_FINALIZE or CC_UNFINALIZE', BRANCH_CODE), "/index.php");}/*function open_from_dc($url,$user_id,$bid, $extra_param = ''){	global $config;		$path = $config['counter_collection_server']."/".$url."?remote=1&id=".mi($user_id)."&branch=".mi($bid);	if($extra_param)    $path .= $extra_param;	//print $path;exit;	header("Location: $path");	exit;}*///print_r($_SERVER);if($config['counter_collection_server']){	// it is called by ajax	if(isset($_SERVER['HTTP_X_REQUESTED_WITH'])){	    print "<span style='color:red;'><u>* Data maybe inaccurate if server sync is not tally.</u><br /></span>";	    /*$url = "counter_collection.php";	    $tmp = array();	    if($_REQUEST){			foreach($_REQUEST as $key=>$value){				if($key=='PHPSESSID' || $key=='arms_login_branch')   continue;				$tmp[] = "$key=$value";			}		}	    $extra_param = "&redirect_path=".urlencode($url."?".join('&', $tmp));	    $bid = $_REQUEST['branch'] ? $_REQUEST['branch'] : $sessioninfo['branch_id'];	    open_from_dc($url, $sessioninfo['id'], $bid, $extra_param);		exit;*/	}else{		$smarty->assign('no_menu_templates', 1);		$smarty->display('header.tpl');		//print "<script>open_cc('".$config['counter_collection_server']."','".$sessioninfo['id']."','".$sessioninfo['branch_id']."');</script>";		print "<script>open_cc2('".$config['counter_collection_server']."','".$_SERVER['REQUEST_URI']."','".$sessioninfo['branch_id']."','".$sessioninfo['id']."');</script>";		print "Please refer to popup.";		exit;	}	}require_once('counter_collection.include.php');require('counter_collection3.php');?>